name: Auto PR to main

on:
  push:
    branches: [ sylvain, phily, ethan, virgile ]

permissions:
  pull-requests: write
  contents: read

jobs:
  pr:
    runs-on: ubuntu-latest
    steps:
      - name: Create PR if missing
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
        run: |
          set -e
          BRANCH="${GITHUB_REF_NAME}"

          PR_NUMBER=$(gh pr list --head "$BRANCH" --base main --state open --json number -q '.[0].number' || true)

          if [ -n "$PR_NUMBER" ]; then
            echo "PR already open: #$PR_NUMBER"
            exit 0
          fi

          echo "Creating PR: $BRANCH -> main"
          if gh pr create \
            --head "$BRANCH" \
            --base main \
            --title "Merge ${BRANCH} -> main" \
            --body "PR automatique : ${BRANCH} -> main"
          then
            echo "PR created."
          else
            echo "No diff / nothing to merge. OK."
            exit 0
          fi
