name: Discord Test

on:
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Test webhook (updates)
        env:
          WEBHOOK: ${{ secrets.DISCORD_WEBHOOK_UPDATES }}
          PING: ${{ secrets.DISCORD_PING_UPDATES }}
        run: |
          python3 - <<'PY'
          import os, json, urllib.request, urllib.error

          url = os.environ.get("WEBHOOK","")
          ping = os.environ.get("PING","").strip()

          payload = {
            "content": (ping + "\n" if ping else "") + "Test webhook depuis GitHub Actions âœ…",
            "allowed_mentions": {"parse": ["roles"]}
          }

          data = json.dumps(payload).encode("utf-8")
          req = urllib.request.Request(url, data=data, headers={"Content-Type":"application/json"})

          try:
            r = urllib.request.urlopen(req).read().decode("utf-8", errors="ignore")
            print("OK: message envoye.")
          except urllib.error.HTTPError as e:
            body = e.read().decode("utf-8", errors="ignore")
            print(f"HTTP {e.code}")
            print(body)
            raise
          PY
